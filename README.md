TOC:

- [ℹ️ About](#ℹ️-about)
- [✨ Getting Started](#-getting-started)
- [🏗️ Workflow](#️-workflow)
  - [Branches](#branches)
  - [Commit messages](#commit-messages)
  - [Development cycle](#development-cycle)
- [🔧 Environment setup](#-environment-setup)
  - [Env config](#env-config)
  - [Adding a new environment](#adding-a-new-environment)
  - [Required config](#required-config)
  - [Env customization](#env-customization)
    - [Nav \& sub pages](#nav--sub-pages)
      - [Nav](#nav)
      - [Sub page creation](#sub-page-creation)
    - [Theming](#theming)
    - [Images](#images)
- [📡 DharmaMitra API client \& typing](#-dharmamitra-api-client--typing)
  - [Regular fetchs](#regular-fetchs)
  - [SSE fetchs](#sse-fetchs)
    - [Stream formatting markers](#stream-formatting-markers)
- [🌐 Internationalization (i18n)](#-internationalization-i18n)
  - [Locale content update workflow](#locale-content-update-workflow)
  - [Internal navigation](#internal-navigation)
  - [Referrences](#referrences)
- [🎨 Theming](#-theming)
  - [Config](#config)
  - [Env specific theming](#env-specific-theming)
  - [References](#references)
- [🧪 Testing](#-testing)
- [📦 Containerization](#-containerization)
  - [Simple setting](#simple-setting)
  - [Compose setting](#compose-setting)
- [🚢 Deployment](#-deployment)

## ℹ️ About

Dharmamitra frontend v2 — a [Next.js](https://nextjs.org/) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app). The project uses:

- [`next/font`](https://nextjs.org/docs/basic-features/font-optimization) to automatically optimize and load Inter, a custom Google Font.
- [`next-intl`](https://next-intl-docs.vercel.app/docs) ([examples](https://github.com/amannn/next-intl/tree/main/examples)).
- query tools: [`openapi-typescript`](https://openapi-ts.pages.dev/introduction), [`openapi-fetch`](https://openapi-ts.pages.dev/openapi-fetch/), and [`@tanstack/react-query`](https://tanstack.com/query/latest/docs/framework/react/overview)
- [`Material UI`](https://mui.com/material-ui/getting-started/) with [Next.js App routing integration](https://mui.com/material-ui/integrations/nextjs/)
- [linting tools](https://medium.com/yavar/setting-up-a-eslint-prettier-husky-and-lint-staged-integration-with-typescript-in-next-js-13-14-68044dfae920#ec5e): `eslint`, `prettier`, `simple-import-sort`, `husky`, and `lint-staged`
  - [`husky`](https://typicode.github.io/husky/) uses v9 config
  - all git hooks can be skipped by adding a `-n/--no-verify` option.
- [`playwrite`](https://playwright.dev/docs/intro) and [`@axe-core/playwright`](https://www.npmjs.com/package/@axe-core/playwright)
- [`semantic-release`](https://semantic-release.gitbook.io/semantic-release) for releases automation

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

## ✨ Getting Started

The project has [migrated from Yarn Classic](https://yarnpkg.com/migration/overview) and uses Yarn Modern\* (aka Yarn v2+, aka Yarn Berry) with the [`node_modules` install strategy](https://yarnpkg.com/features/linkers) without [Zero-installs](https://yarnpkg.com/getting-started/qa#which-files-should-be-gitignored). [Install yarn if necessary](https://yarnpkg.com/getting-started/install).

Once installed, run the development server:

```bash
yarn dev
```

Open [http://localhost:3000](http://localhost:3000) (adding an environment base path if necessary) with your browser to see the home page generated by `src/app/[locale]/page.tsx`.

**Notes:**

- \* note Yarn Modern's [breaking changes](https://yarnpkg.com/migration/guide#breaking-changes), including dropping support for `pre` & `post` scripts and renaming of `--frozen-lockfile` into `--immutable`.
- [yarn cli commands](https://yarnpkg.com/cli)
- [about Yarn 4](https://portal.gitnation.org/contents/yarn-4-modern-package-management)

## 🏗️ Workflow

### Branches

- `main`: for production deployment
- `dev`: for staging deployment
- `content`: exclusively for making content updates to `messages/*`, `src/assets/*`, `src/app/[locale]/team/data.ts`, or similar content data files.
- development item branches linked to issue numbers

`dev` has been set as the [default GitHub branch](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-branches#about-the-default-branch) and all new PRs will be opened against `dev` by default.

### Commit messages

Automated release updates depend on standardized commit messages following the [Angular Commit Message Conventions](https://github.com/angular/angular/blob/main/CONTRIBUTING.md#-commit-message-format):

> - **build**: Changes that affect the build system or external dependencies (example scopes: gulp, broccoli, npm)
> - **ci**: Changes to our CI configuration files and scripts (examples: CircleCi, SauceLabs)
> - **docs**: Documentation only changes
> - **feat**: A (completed) new feature
> - **fix**: A bug fix
> - **perf**: A code change that improves performance
> - **refactor**: A code change that neither fixes a bug nor adds a feature
> - **test**: Adding missing tests or correcting existing tests

In addition to the Angular converntion:

**wip**: work in progress for a feature or fix
**content**: content updates (TODO: configure semantic-release for this)

`semantic-release` uses commit messages to handle versoning as follows:

| **Commit message**                                                                                                                                                                        | **Release type**                                                                                        |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- |
| `fix: stop graphite breaking when too much pressure applied`                                                                                                                              | Fix (Patch) Release                                                                                     |
| `feat: add 'graphiteWidth' option`                                                                                                                                                        | Feature (Minor) Release                                                                                 |
| `perf: remove graphiteWidth option`<br> <br>`BREAKING CHANGE: The graphiteWidth option has been removed.`<br>`The default graphite width of 10mm is always used for performance reasons.` | Breaking (Major) Release ((Note that the `BREAKING CHANGE`: token must be in the footer of the commit)) |

### Development cycle

1. New item specification defined in an issue with clear acceptance criteria
2. A new branch under the issue number is created for the work
3. On completion a PR will be opened against `dev`
4. When a PR is accepted the new work will be deployed on staging for testing
5. After final sign-off a PR will be opened from `dev` to `main` and `semantic-release` will handle release versions based on commits.
6. Deploy to production from `main`.

## 🔧 Environment setup

### Env config

- adapted from [Best Practices for Handling Per-Environment Configuration in Your JS/TS Applications](https://www.raulmelo.me/en/blog/best-practices-for-handling-per-environment-config-js-ts-applications#the-config-strategy)

- environment specific build scripts (in `package.json`) set the `NEXT_PUBLIC_APP_ENV` used to define app config (including features, options to render) for each environment.
  - A prebuild step runs to envoke the env setter. Eg. when `yarn build:pub` is run the `prebuild:pub` script executes first, setting the environment in `.env.production`. **note**: This overwrites the `.env.production` file. Almost all app variables should be set in the default / env config files, but if there is a need for additional variables to be added to the env file, it needs to be added to `scripts/set_env.sh`
  - Next.js automatically loads environment variables from `.env.local`, `.env.development`, `.env.production`, and `.env.test`. The prebuild step allows us to maintain the standard file names and use Next.js's built-in environment loading strategy.

### Adding a new environment

These steps can also be adjusted and used for renaming an environment.

- add the env alias to `SUPPORTED_ENVS` in `src/config/defineConfig.ts`
- create an new env specific config file in `src/config/envs` (adjust settings as required, with `defineConfig` as a ref.)
- import the env's config file to `src/config/index.ts` and add the env alias to config getter ("if section")
- add environment alias to the `servedAtRoot` in `next.config.mjs` if the environment's base path is `/` (_this shouldn't be applicable in most cases_)
- add an env specific build script to `package.json`. Eg. for the `lab` env:

  ```
  "prebuild:lab": "sh ./scripts/set_env.sh lab",
  "build:lab": "next build",
  ```

- add a new service block for the env to `docker-compose.yaml`
  - the env needs to be mapped to a new port
  - the env container name needs to be added to the `nginx` service dependency list.
- add the env to `nginx/default.conf`

### Required config

- if a config property needs to be set in all env config files add it to the `RequiredConfigKeys` type in `src/config/defineConfig.ts`

### Env customization

#### Nav & sub pages

- all possible sub pages need to be

  - defined in `allPages` in `src/config/defineConfig.ts`
  - added to the `pages` prop of each i18n file (ie. `messages/en.json` etc.)
  - have a corresponding page prop in each i18n file with sub keys for each applicable environment. eg:

    ```json
    "About": {
      "dharmamitra": {...},
      "envname": {...},
    }
    ```

- sub page configuration:
  - dharmamitra envs can rely on `defaultSubPages` and need no further configuration;
  - the `subPages` prop of the env config file needs to be set for customer sub pages with either an array of sub pages (`["guide"]`), or an empty array.

##### Nav

The above configuration feeds into the `useNavItems` hook and takes care of app bar navigation.

##### Sub page creation

(See: `src/app/[locale]/about` for full example)

Custom env sub pages are handled with Next Js's [Parallel Routes](https://nextjs.org/docs/app/building-your-application/routing/parallel-routes) which allows env specific content to be slotted into a page's `layout.tsx` file.

- The page group `layout.tsx` needs to:

  - export a `generateStaticParams` function that returns an array of `params` for each page in the group, including the `locale` param.
  - include a param for each env content page (corresponding to `@envcontent` directory)
  - include a check if the env has the given route:

    ```js
    if (!isEnvRoute) {
      notFound()
    }
    ```

- The page group top-level `page.tsx`:

  - only handles page metadata
  - returns nothing

- Slot directories need to be created for each env content page (eg `@dharmamitra`) which will render the actual content for the given env.

In addidition to enable static rendering it's necessary to follow the [next-intl static rendering guide](https://next-intl-docs.vercel.app/docs/getting-started/app-router/with-i18n-routing#static-rendering)

#### Theming

See: [🎨 Theming](#-theming)

#### Images

- env specific images are stored in `public`
- paths to these images are defined in `assetPaths` in `src/config/defineConfig.ts`
- `basePath` must be added when using images in the `public` dir

example usage

```js
// src/components/Logo.tsx

  const {
    basePath,
    assetPaths: { logoSrc },
  } = useAppConfig()

  ...

  <Image
    src={basePath + logoSrc}
    alt="Logo"
    sizes="100vw"
    width={240}
    height={66}
    priority
  />

```

## 📡 DharmaMitra API client & typing

[Dharmamitra API docs](https://dharmamitra.org/api/docs#/)

The project uses [`openapi-typescript`](https://openapi-ts.pages.dev/introduction) and [`openapi-fetch`](https://openapi-ts.pages.dev/openapi-fetch/) to interface with the API. In addition, as we need to do client-side fetching, we also use `@tanstack/react-query`.

DM API request and response model types are generated from the project's [OpenAPI schema](https://dharmamitra.org/api/openapi.json) by running:

```sh
yarn api:codegen
```

### Regular fetchs

`openapi-fetch`'s api client (instantiated in `utils/api/client.ts`) is used in dedicated endpoint functions to fetch typed data ([see docs](https://openapi-ts.pages.dev/openapi-fetch/)) from the API.

### SSE fetchs

TODO

#### Stream formatting markers

The list of unique characters from unicode emojis (https://emojipedia.org/) used to format stream responses is maintained in `streamMarkers` in `src/components/styled.tsx`

| Marker | Emoji Name        | Description                                    |
| ------ | ----------------- | ---------------------------------------------- |
| `🔽`   | downwards-button  | line break                                     |
| `⏮️`   | last-track-button | start of meta formating                        |
| `⏭️`   | next-track-button | end of meta formating                          |
| `⚠️`   | warning           | warning (followed by i18n warning message key matching the pattern `\w+`) |
| `🚫`   | prohibited        | failure (followed by i18n --"--)   |

## 🌐 Internationalization (i18n)

- The [Unicode Common Locale Data Repository (CLDR)](https://cldr.unicode.org/index/charts) locale codes used by [Javascripts's Internationalization API](https://tc39.es/ecma402/#sec-implementation-dependencies) are used for the project's locale codes to define the project's supported locales.

- Supported locales are defined in the `supportedLocales` varriable in `src/config.ts` and locale files with matching file names are added to the `messages/` directory.
- `messages/` files use the convention of title-case keys for page content and camel-case keys for component content.

### Locale content update workflow

TODO (https://stackoverflow.com/questions/14500240/how-can-i-generate-a-diff-for-a-single-file-between-two-branches-in-github)

DRAFT model (consideration of special needs for translation updates pending)

1. `git checkout dev`
2. `git pull`
3. `git checkout content-updates`
4. `git merge dev`
5. Make content updates (**note:** only copy can be changed, if a new translation key is needed, this will have to be synchronized with a UI update)
6. Commit, push and open an PR into `dev`
7. On PR merge, review changes on staging
8. If all looks good, open a PR from `dev` to `main`
9. On PR merge, the updates will be ready for production deploy.

### Internal navigation

- most internal navigation can be handled with `src/components/LocalLink.tsx`.
- where needed `redirect`, `usePathname`, `useRouter` exported from `src/navigation.ts` can be used to make sure internationalized routes are correctly handled.

### Referrences

- [Locale code list](https://www.alchemysoftware.com/livedocs/ezscript/Topics/Catalyst/Language.htm)
- [Latest CLDR locale data chart](https://www.unicode.org/cldr/charts/latest/summary/root.html)

## 🎨 Theming

The project uses [`Material UI`](https://mui.com/material-ui/getting-started/) with [Next.js integration](https://mui.com/material-ui/integrations/nextjs/).

### Config

The theme is configured in a static `.ts` file (`src/utils/theme/config.ts`) so that custom design tokens can be used in both sever and client components.

For server components **theme-aware** propeties are readily available via component's `sx` prop. Additionally, `customTheming` can be imported to get access to these styles. In client components the same custome styles can be accessed via the theme's `custom` prop:

```jsx
<Box
  sx={{
    borderBottomRightRadius: (theme) => theme.custom.shape.inputRadius,
  }}
/>
```

### Env specific theming

Environment specific theme colours can be set in `envRgbCodes` in `src/config/defineConfig.ts`

### References

- [Mui's default theme object](https://mui.com/material-ui/customization/default-theme/)
- [MUI's theme-aware propeties](https://mui.com/system/getting-started/the-sx-prop/#theme-aware-properties) - these are props available to any component without importing `theme`
- [index of color utilities exported from `@mui/material/styles`](https://github.com/mui/material-ui/blob/master/packages/mui-material/src/styles/index.d.ts#L52-L67) (see: [cusomizing colours](https://mui.com/material-ui/customization/palette/#custom-colors))

## 🧪 Testing

Build testing by-passing eslint:

```sh
NEXT_DISABLE_ESLINT=true yarn build
```

Playwright commands (these tests can be run the script command `yarn test:pw [OPTIONS]`):

```sh
# Run the end-to-end tests.
yarn playwright test

# Starts the interactive UI mode.
yarn playwright test --ui

# Runs the tests only on Desktop Chrome.
yarn playwright test --project=chromium

# Runs the tests in a specific file.
yarn playwright test example

# Runs the tests and opens a browser window
yarn playwright test --headed

# Runs the tests in debug mode.
yarn playwright test --debug

# Auto generate tests with Codegen.
yarn playwright codegen
```

If you want to use visual comparison to test pages render:

- when there are no base comparison images, a test run will fail once, but thereafter succeed (the base images are generated during the run)
- when there is a change to the UI, existing base comparison images will need to be updated with `yarn playwright test --update-snapshots`.

Visit https://playwright.dev/docs/intro for more information

## 📦 Containerization

### Simple setting

```sh
docker build . --tag {TAG}  --no-cache
docker run --detach --rm --publish 3333:3000 --name {TAG} {TAG}
```

`3000` is the default port for Next.js apps so here we publish it on local port `3333` to avoid port conflics with other locally deployed apps (i.e. BN).

The project will be available at `http://localhost:3333/{TAG}`. To shut it down gracefully run:

```sh
docker stop {TAG}
```

### Compose setting

Base command:

```sh
docker compose build --no-cache && docker compose up --force-recreate -d
```

Set env variables:

```sh
export RESTART_POLICY=no
docker compose build --no-cache && docker compose up --force-recreate -d
```

Disable the progress indicator and get more detailed output

```sh
docker compose build --no-cache --progress=plain
```

NGINX is added to the docker-compose setting so that the environment is more production-like with a webserver in front of the app.
The app is again available under `localhost:3333` e.g. `http://localhost:3333/dmnext/bo/about`.

The server (published locally on port 80) functions as a proxy so the same page should be reachable over `http://localhost/dmnext/bo/about`

If you want to see the NGINX logs you can use (press Ctrl-C to exit):

```sh
docker logs nginx -f
```

## 🚢 Deployment

[Deploument workflow](https://www.figma.com/board/1H4N9FXyp0C0Vf7whd2aCK/Deployment-workflow?node-id=0-1&t=4E1ZQIDxTzHlmdMB-0) model.
