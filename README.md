# dharmamitra-frontend-next

Dharmamitra frontend v2 â€” a [Next.js](https://nextjs.org/) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).

## Getting Started

First, run the development server:

```bash
yarn dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the home page generated by `src/app/page.tsx`.

This project uses:

- [`next/font`](https://nextjs.org/docs/basic-features/font-optimization) to automatically optimize and load Inter, a custom Google Font.
- [`next-intl`](https://next-intl-docs.vercel.app/docs) ([examples](https://github.com/amannn/next-intl/tree/main/examples)).
- query tools: [`openapi-typescript`](https://openapi-ts.pages.dev/introduction), [`openapi-fetch`](https://openapi-ts.pages.dev/openapi-fetch/), and [`@tanstack/react-query`](https://tanstack.com/query/latest/docs/framework/react/overview)
- [`Material UI`](https://mui.com/material-ui/getting-started/) with [Next.js App routing integration](https://mui.com/material-ui/integrations/nextjs/)
- [linting tools](https://medium.com/yavar/setting-up-a-eslint-prettier-husky-and-lint-staged-integration-with-typescript-in-next-js-13-14-68044dfae920#ec5e): `eslint`, `prettier`, `simple-import-sort`, `husky`, and `lint-staged`
  - [`husky`](https://typicode.github.io/husky/) uses v9 config
  - all git hooks can be skipped by adding a `-n/--no-verify` option.
- [`playwrite`](https://playwright.dev/docs/intro) and [`@axe-core/playwright`](https://www.npmjs.com/package/@axe-core/playwright)
- [`semantic-release`](https://semantic-release.gitbook.io/semantic-release) for releases automation

### Next.js

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js/) - your feedback and contributions are welcome!

## Project config & workflow (UNDER DEVELOPMENT)

### Config

- adapted from [Best Practices for Handling Per-Environment Configuration in Your JS/TS Applications](https://www.raulmelo.me/en/blog/best-practices-for-handling-per-environment-config-js-ts-applications#the-config-strategy)

- environment specific build scripts set the `NEXT_PUBLIC_APP_ENV` used to define app config for each environment. A prebuild step runs to envoke the env setter, so when eg. `yarn build:dm-production`, is run the `prebuild:dm-production` script executes first, setting. 
  - Next.js automatically loads environment variables from `.env.local`, `.env.development`, `.env.production`, and  `.env.test`  This method allows you to maintain the standard file names and leverage Next.js's built-in environment loading strategy.

### Branches:

- `main`: for production deployment
- `dev`: for staging deployment
- `content`: exclusively for making content updates to `messages/*`, `src/assets/*`, `src/app/[locale]/team/data.ts`, or similar content data files. 
- development item branches linked to issue numbers

`dev` has been set as the [default GitHub branch](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-branches#about-the-default-branch) and all new PRs will be opened against `dev` by default.

### Commit messages

Automated release updates depend on standardized commit messages following the [Angular Commit Message Conventions](https://github.com/angular/angular/blob/main/CONTRIBUTING.md#-commit-message-format):

> - **build**: Changes that affect the build system or external dependencies (example scopes: gulp, broccoli, npm)
> - **ci**: Changes to our CI configuration files and scripts (examples: CircleCi, SauceLabs)
> - **docs**: Documentation only changes
> - **feat**: A new feature
> - **fix**: A bug fix
> - **perf**: A code change that improves performance
> - **refactor**: A code change that neither fixes a bug nor adds a feature
> - **test**: Adding missing tests or correcting existing tests

`semantic-release` uses commit messages to handle versoning as follows:

| **Commit message**                                                                                                                                                                        | **Release type**                                                                                        |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- |
| `fix: stop graphite breaking when too much pressure applied`                                                                                                                              | Fix (Patch) Release                                                                                     |
| `feat: add 'graphiteWidth' option`                                                                                                                                                        | Feature (Minor) Release                                                                                 |
| `perf: remove graphiteWidth option`<br> <br>`BREAKING CHANGE: The graphiteWidth option has been removed.`<br>`The default graphite width of 10mm is always used for performance reasons.` | Breaking (Major) Release ((Note that the `BREAKING CHANGE`: token must be in the footer of the commit)) |

### Development cycle:

1. New item specification defined in an issue with clear acceptance criteria
2. A new branch under the issue number is created for the work
3. On completion a PR will be opened against `dev`
4. When a PR is accepted the new work will be deployed on staging for testing
5. After final sign-off a PR will be opened from `dev` to `main` and `semantic-release` will handle release versions based on commits.
6. Deploy to production from `main`.

## Containerization

### Simple setting

```sh
docker build . --tag dmnext  --no-cache
docker run --detach --rm --publish 3333:3000 --name dmnext dmnext
```

`3000` is the default port for Next.js apps so here we publish it on local port `3333` to avoid port conflics with other locally deployed apps (i.e. BN).

The project will be available at `http://localhost:3333/dmnext`. To shut it down gracefully run:

```sh
docker stop dmnext
```

### Compose setting

```
docker compose build --no-cache && docker compose up --force-recreate -d
```

NGINX is added to the docker-compose setting so that the environment is more production-like with a webserver in front of the app.
The app is again available under `localhost:3333` e.g. `http://localhost:3333/dmnext/bo/about`.

The server (published locally on port 80) functions as a proxy so the same page should be reachable over `http://localhost/dmnext/bo/about`

If you want to see the NGINX logs you can use (press Ctrl-C to exit):

```
docker logs nginx -f
```

## DharmaMitra API client & typing

[Dharmamitra API docs](https://dharmamitra.org/api/docs#/)

The project uses [`openapi-typescript`](https://openapi-ts.pages.dev/introduction) and [`openapi-fetch`](https://openapi-ts.pages.dev/openapi-fetch/) to interface with the API. In addition, as we need to do client-side fetching, we also use `@tanstack/react-query`.

DM API request and response model types are generated from the project's [OpenAPI schema](https://dharmamitra.org/api/openapi.json) by running:

```
yarn api:codegen
```

### Regular fetchs

`openapi-fetch`'s api client (instantiated in `utils/api/client.ts`) is used in dedicated endpoint functions to fetch typed data ([see docs](https://openapi-ts.pages.dev/openapi-fetch/)) from the API.

### SSE fetchs

TODO

## i18n

- The [Unicode Common Locale Data Repository (CLDR)](https://cldr.unicode.org/index/charts) locale codes used by [Javascripts's Internationalization API](https://tc39.es/ecma402/#sec-implementation-dependencies) are used for the project's locale codes to define the project's supported locales.

- Supported locales are defined in the `supportedLocales` varriable in `src/config.ts` and locale files with matching file names are added to the `messages/` directory.
- `messages/` files use the convention of title-case keys for page content and camel-case keys for component content.

### Updating locale content

TODO (https://stackoverflow.com/questions/14500240/how-can-i-generate-a-diff-for-a-single-file-between-two-branches-in-github)



### Internal navigation

- most internal navigation can be handled with `src/components/LocalLink.tsx`.
- where needed `redirect`, `usePathname`, `useRouter` exported from `src/navigation.ts` can be used to make sure internationalized routes are correctly handled.

### Referrences:

- [Locale code list](https://www.alchemysoftware.com/livedocs/ezscript/Topics/Catalyst/Language.htm)
- [Latest CLDR locale data chart](https://www.unicode.org/cldr/charts/latest/summary/root.html)

## Theming

The project uses [`Material UI`](https://mui.com/material-ui/getting-started/) with [Next.js integration](https://mui.com/material-ui/integrations/nextjs/).

### Config

The theme is configured in a static `.ts` file (`src/utils/theme/config.ts`) so that custom design tokens can be used in both sever and client components.

For server components **theme-aware** propeties are readily available via component's `sx` prop. Additionally, `customTheming` can be imported to get access to these styles. In client components the same custome styles can be accessed via the theme's `custom` prop:

```
 sx={{
  borderBottomRightRadius: (theme) => theme.custom.shape.inputRadius,
}}
```

### References:

- [Mui's default theme object](https://mui.com/material-ui/customization/default-theme/)
- [MUI's theme-aware propeties](https://mui.com/system/getting-started/the-sx-prop/#theme-aware-properties) - these are props available to any component without importing `theme`
- [index of color utilities exported from `@mui/material/styles`](https://github.com/mui/material-ui/blob/master/packages/mui-material/src/styles/index.d.ts#L52-L67) (see: [cusomizing colours](https://mui.com/material-ui/customization/palette/#custom-colors))

## Testing

Playwright commands (these tests can be run the script command `yarn test:pw [OPTIONS]`):

```sh
# Run the end-to-end tests.
yarn playwright test

# Starts the interactive UI mode.
yarn playwright test --ui

# Runs the tests only on Desktop Chrome.
yarn playwright test --project=chromium

# Runs the tests in a specific file.
yarn playwright test example

# Runs the tests and opens a browser window
yarn playwright test --headed

# Runs the tests in debug mode.
yarn playwright test --debug

# Auto generate tests with Codegen.
yarn playwright codegen
```

If you want to use visual comparison to test pages render:

- when there are no base comparison images, a test run will fail once, but thereafter succeed (the base images are generated during the run)
- when there is a change to the UI, existing base comparison images will need to be updated with `yarn playwright test --update-snapshots`.

Visit https://playwright.dev/docs/intro for more information
