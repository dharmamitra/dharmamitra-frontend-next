TOC:

- [ℹ️ About](#ℹ️-about)
- [✨ Getting Started](#-getting-started)
- [🏗️ Workflow](#️-workflow)
  - [Branches](#branches)
  - [Commit messages](#commit-messages)
    - [Public facing features](#public-facing-features)
    - [`semantic-release`](#semantic-release)
  - [Development cycle](#development-cycle)
- [🔧 Environment setup](#-environment-setup)
  - [Env config](#env-config)
  - [Adding a new environment](#adding-a-new-environment)
  - [Required config](#required-config)
  - [Env customization](#env-customization)
    - [Nav \& sub pages](#nav--sub-pages)
      - [Nav](#nav)
      - [Sub page creation](#sub-page-creation)
    - [Theming](#theming)
    - [Images](#images)
- [📡 DharmaMitra API client \& typing (UPDATE IN PROGRESS)](#-dharmamitra-api-client--typing-update-in-progress)
  - [APIs](#apis)
  - [API models](#api-models)
  - [Regular fetchs](#regular-fetchs)
  - [SSE fetchs](#sse-fetchs)
    - [Stream formatting markers](#stream-formatting-markers)
- [🌐 Content updates \& Internationalization (i18n)](#-content-updates--internationalization-i18n)
  - [Locale content update workflow](#locale-content-update-workflow)
  - [Internal navigation](#internal-navigation)
  - [Referrences](#referrences)
- [🎨 Theming](#-theming)
  - [Config](#config)
  - [Env specific theming](#env-specific-theming)
  - [References](#references)
- [🧪 Testing](#-testing)
- [👷 Building](#-building)
  - [Running a test build by-passing eslint](#running-a-test-build-by-passing-eslint)
  - [Running a local build](#running-a-local-build)
- [📦 Containerization](#-containerization)
  - [Single project variant](#single-project-variant)
  - [Multiple Docker services](#multiple-docker-services)
- [🚢 Deployment](#-deployment)

## ℹ️ About

Dharmamitra frontend v2 — a [Next.js](https://nextjs.org/) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app). The project uses:

- [`next/font`](https://nextjs.org/docs/basic-features/font-optimization) to automatically optimize and load Inter, a custom Google Font.
- [`next-intl`](https://next-intl-docs.vercel.app/docs) ([examples](https://github.com/amannn/next-intl/tree/main/examples)).
- query tools: [`openapi-typescript`](https://openapi-ts.pages.dev/introduction), [`openapi-fetch`](https://openapi-ts.pages.dev/openapi-fetch/), and [`@tanstack/react-query`](https://tanstack.com/query/latest/docs/framework/react/overview)
- [`Material UI`](https://mui.com/material-ui/getting-started/) with [Next.js App routing integration](https://mui.com/material-ui/integrations/nextjs/)
- [linting tools](https://medium.com/yavar/setting-up-a-eslint-prettier-husky-and-lint-staged-integration-with-typescript-in-next-js-13-14-68044dfae920#ec5e): `eslint`, `prettier`, `simple-import-sort`, `husky`, and `lint-staged`
  - [`husky`](https://typicode.github.io/husky/) uses v9 config
  - all git hooks can be skipped by adding a `-n/--no-verify` option.
- [`playwrite`](https://playwright.dev/docs/intro) and [`@axe-core/playwright`](https://www.npmjs.com/package/@axe-core/playwright)
- [`semantic-release`](https://semantic-release.gitbook.io/semantic-release) for releases automation

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

## ✨ Getting Started

The project has [migrated from Yarn Classic](https://yarnpkg.com/migration/overview) and uses Yarn Modern\* (aka Yarn v2+, aka Yarn Berry) with the [`node_modules` install strategy](https://yarnpkg.com/features/linkers) without [Zero-installs](https://yarnpkg.com/getting-started/qa#which-files-should-be-gitignored). [Install yarn if necessary](https://yarnpkg.com/getting-started/install).

Once installed, run the development server:

```bash
yarn dev
```

Open [http://localhost:3000](http://localhost:3000) (adding an environment base path if necessary) with your browser to see the home page generated by `src/app/[locale]/page.tsx`.

**Notes:**

- \* note Yarn Modern's [breaking changes](https://yarnpkg.com/migration/guide#breaking-changes), including dropping support for `pre` & `post` scripts and renaming of `--frozen-lockfile` into `--immutable`.
- [yarn cli commands](https://yarnpkg.com/cli)
- [about Yarn 4](https://portal.gitnation.org/contents/yarn-4-modern-package-management)

## 🏗️ Workflow

### Branches

- `main`: for production deployment
- `dev`: for staging deployment
- `content`: exclusively for making content updates to `messages/*`, `src/assets/*`, `src/app/[locale]/team/data.ts`, or similar content data files.
- development item branches linked to issue numbers

`dev` has been set as the [default GitHub branch](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-branches#about-the-default-branch) and all new PRs will be opened against `dev` by default.

### Commit messages

Automated release updates depend on standardized commit messages following the [Angular Commit Message Conventions](https://github.com/angular/angular/blob/main/CONTRIBUTING.md#-commit-message-format):

> - **build**: Changes that affect the build system or external dependencies (example scopes: gulp, broccoli, npm)
> - **ci**: Changes to our CI configuration files and scripts (examples: CircleCi, SauceLabs)
> - **docs**: Documentation only changes
> - **feat**: A (completed) new feature
> - **fix**: A bug fix
> - **perf**: A code change that improves performance
> - **refactor**: A code change that neither fixes a bug nor adds a feature
> - **test**: Adding missing tests or correcting existing tests

In addition to the Angular converntion:

**wip**: work in progress for a feature or fix
**content**: content updates (TODO: configure semantic-release for this)

#### Public facing features

(as of v1.2.0) Features specifically for the public facing site can include `(pub)` ahead of the main commit description (eg. `feat: (pub) Japanese, German, French, Italian translation support` )

#### `semantic-release`

`semantic-release` uses commit messages to handle versoning as follows:

| **Commit message**                                                                                                                                                                        | **Release type**                                                                                        |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- |
| `fix: stop graphite breaking when too much pressure applied`                                                                                                                              | Fix (Patch) Release                                                                                     |
| `feat: add 'graphiteWidth' option`                                                                                                                                                        | Feature (Minor) Release                                                                                 |
| `perf: remove graphiteWidth option`<br> <br>`BREAKING CHANGE: The graphiteWidth option has been removed.`<br>`The default graphite width of 10mm is always used for performance reasons.` | Breaking (Major) Release ((Note that the `BREAKING CHANGE`: token must be in the footer of the commit)) |

### Development cycle

1. New item specification defined in an issue with clear acceptance criteria
2. A new branch under the issue number is created for the work
3. On completion a PR will be opened against `dev`
4. When a PR is accepted the new work will be deployed on staging for testing
5. After final sign-off a PR will be opened from `dev` to `main` and `semantic-release` will handle release versions based on commits.
6. Deploy to production from `main`.

## 🔧 Environment setup

### Env config

- adapted from [Best Practices for Handling Per-Environment Configuration in Your JS/TS Applications](https://www.raulmelo.me/en/blog/best-practices-for-handling-per-environment-config-js-ts-applications#the-config-strategy)

- environment specific build scripts (in `package.json`) set the `NEXT_PUBLIC_BUILD_VARIANT` used to define app config (including features, options to render) for each environment.
  - A prebuild step runs to envoke the env setter. Eg. when `yarn build:pub` is run the `prebuild:pub` script executes first, setting the environment in `.env`. **note**: This overwrites the `.env` file. Almost all app variables should be set in the default / env config files, but if there is a need for additional variables to be added to the env file, it needs to be added to `scripts/set_build_variant.sh`

### Adding a new environment

These steps can also be adjusted and used for renaming an environment.

- add the env alias to `BUILD_VARIANTS` in `src/config/defineConfig.ts`
- create an new env specific config file in `src/config/envs` (adjust settings as required, with `defineConfig` as a ref.)
- import the env's config file to `src/config/index.ts` and add the env alias to config getter ("if section")
- add environment alias to the `servedAtRoot` in `next.config.mjs` if the environment's base path is `/` (_this shouldn't be applicable in most cases_)
- add an env specific build script to `package.json`. Eg. for the `lab` env:

  ```json
  "prebuild:lab": "sh ./scripts/set_build_variant.sh lab",
  "build:lab": "next build",
  ```

- add a new service block for the env to `docker-compose.yaml`
  - the env needs to be mapped to a new port
  - the env container name needs to be added to the `nginx` service dependency list.
- add the env to `nginx/default.conf`

### Required config

- if a config property needs to be set in all env config files add it to the `RequiredConfigKeys` type in `src/config/defineConfig.ts`

### Env customization

#### Nav & sub pages

- all possible sub pages need to be

  - defined in `allPages` in `src/config/defineConfig.ts`
  - added to the `pages` prop of each i18n file (ie. `messages/en.json` etc.)
  - have a corresponding page prop in each i18n file with sub keys for each applicable environment. eg:

    ```json
    "About": {
      "dharmamitra": {...},
      "envname": {...},
    }
    ```

- sub page configuration:
  - dharmamitra envs can rely on `defaultSubPages` and need no further configuration;
  - the `subPages` prop of the env config file needs to be set for customer sub pages with either an array of sub pages (`["guide"]`), or an empty array.

##### Nav

The above configuration feeds into the `useNavItems` hook and takes care of app bar navigation.

##### Sub page creation

(See: `src/app/[locale]/about` for full example)

Custom env sub pages are handled with Next Js's [Parallel Routes](https://nextjs.org/docs/app/building-your-application/routing/parallel-routes) which allows env specific content to be slotted into a page's `layout.tsx` file.

- The page group `layout.tsx` needs to:

  - export a `generateStaticParams` function that returns an array of `params` for each page in the group, including the `locale` param.
  - include a param for each env content page (corresponding to `@envcontent` directory)
  - include a check if the env has the given route:

    ```js
    if (!isEnvRoute) {
      notFound()
    }
    ```

- The page group top-level `page.tsx`:

  - only handles page metadata
  - returns nothing

- Slot directories need to be created for each env content page (eg `@dharmamitra`) which will render the actual content for the given env.

In addidition, to enable static rendering it's necessary to follow the [next-intl static rendering guide](https://next-intl-docs.vercel.app/docs/getting-started/app-router/with-i18n-routing#static-rendering)

#### Theming

See: [🎨 Theming](#-theming)

#### Images

- env specific images are stored in `public`
- paths to these images are defined in `assetPaths` in `src/config/defineConfig.ts`
- `basePath` must be added when using images in the `public` dir

example usage

```js
// src/components/Logo.tsx

  const {
    basePath,
    assetPaths: { logoSrc },
  } = useAppConfig()

  ...

  <Image
    src={basePath + logoSrc}
    alt="Logo"
    sizes="100vw"
    width={240}
    height={66}
    priority
  />

```

## 📡 DharmaMitra API client & typing (UPDATE IN PROGRESS)

The project uses [`openapi-typescript`](https://openapi-ts.pages.dev/introduction) and [`openapi-fetch`](https://openapi-ts.pages.dev/openapi-fetch/) to interface with the API. In addition, as we need to do client-side fetching, we also use `@tanstack/react-query`.

### APIs

- **Translation**:
  - [docs](https://dharmamitra.org/api/docs#/)
  - [schema](https://dharmamitra.org/api/openapi.json)
- **Search**:
  - [docs](https://dharmamitra.org/api-search/docs#/)
  - [schema](https://dharmamitra.org/api-search/openapi.json)

### API models

`openapi-typescript` is configured in`redocly.yaml`. DM API request and response model types are fetched from the project's OpenAPI JSON schemas defined there and can be generated with:

```sh
# package script
yarn api:ts

# Long form
yarn openapi-typescript
```

### Regular fetchs

`openapi-fetch`'s api client (instantiated in `utils/api/client.ts`) is used in dedicated endpoint functions to fetch typed data ([see docs](https://openapi-ts.pages.dev/openapi-fetch/)) from the API.

### SSE fetchs

TODO

#### Stream formatting markers

The list of unique characters from unicode emojis (https://emojipedia.org/) used to format stream responses is maintained in `markers` in `src/utils/api/stream.ts` and consumed throughout the app via `streamUtils` expirted from `src/utils/api/index.ts`.

## 🌐 Content updates & Internationalization (i18n)

- `messages/en.json` defines the message content model for the project and is the template for all locale files.
- model and content updates are kept in sync across locales by running `yarn i18n:modelsync`
- message syncing has been added as an automated pre-commit step in `.husky/pre-commit`.
- The [Unicode Common Locale Data Repository (CLDR)](https://cldr.unicode.org/index/charts) locale codes used by [Javascripts's Internationalization API](https://tc39.es/ecma402/#sec-implementation-dependencies) are used for the project's locale codes to define the project's supported locales.
- Supported locales are defined in the `supportedLocales` varriable in `src/i18n.ts` and
- Locale files named with the locale code are added to the `messages/` directory (eg. `messages/zh-Hant.json`).
- `messages/` files use the convention of:
  - pascal case keys for page content and
  - camel case keys for component content.

### Locale content update workflow

(**¡NOTE!** only existing message values can be updated without front-end changes. If a new content item/key is needed, this must be synchronized with a coresponding UI update.)

1. `git checkout dev`
2. `git pull`
3. `git checkout content-updates`
4. `git merge dev`
5. make content updates
   - **Updating default locale (EN) content**: make changes to `messages/en.json` values only
     - no changes to keys,
     - no changes to other locale files. Changes to other locale files will be overwritten by `scripts/sync_msg_model.py` on commit. **¡NOTE!** If adding translations as well:
       - first make changes to `en`,
       - commmit, _then_
       - add translation to other locale files
   - **Updating supported locale content only**:
     - English values in locale files are ready for translation
     - in addition to synchronizing `en` keys, when a previously translated value is updated in `en` `sync_msg_model.py` will overwrite the translation with the new English value in the other locale files and new translations will be needed.
     - where relevant, diffing previous commits can give context for message/translation updates (a tradeoff for overall i18n stability is the replacement of translated values with new English key values even if the English changes are trivial - reviewing the diffs is a good way understand what has changed and restore previous translations if needed. In GitHub this can be done for a local file via eg. [https://github.com/dharmamitra/dharmamitra-frontend-next/commits/dev/messages/zh-Hant.json](https://github.com/dharmamitra/dharmamitra-frontend-next/commits/dev/messages/zh-Hant.json))
6. Commit, push and open an PR into `dev`
7. On PR merge, review changes on staging
8. If all looks good, open a PR from `dev` to `main`
9. On PR merge, the updates will be ready for production deploy.

### Internal navigation

- most internal navigation can be handled with `src/components/LocalLink.tsx`.
- where needed `redirect`, `usePathname`, `useRouter` exported from `src/navigation.ts` can be used to make sure internationalized routes are correctly handled.

### Referrences

- [Locale code list](https://www.alchemysoftware.com/livedocs/ezscript/Topics/Catalyst/Language.htm)
- [Latest CLDR locale data chart](https://www.unicode.org/cldr/charts/latest/summary/root.html)

## 🎨 Theming

The project uses [`Material UI`](https://mui.com/material-ui/getting-started/) with [Next.js integration](https://mui.com/material-ui/integrations/nextjs/).

### Config

The theme is configured in a static `.ts` file (`src/utils/theme/config.ts`) so that custom design tokens can be used in both sever and client components.

For server components **theme-aware** propeties are readily available via component's `sx` prop. Additionally, `customTheming` can be imported to get access to these styles. In client components the same custome styles can be accessed via the theme's `custom` prop:

```jsx
<Box
  sx={{
    borderBottomRightRadius: (theme) => theme.custom.shape.inputRadius,
  }}
/>
```

### Env specific theming

Environment specific theme colours can be set in `envRgbCodes` in `src/config/defineConfig.ts`

### References

- [Mui's default theme object](https://mui.com/material-ui/customization/default-theme/)
- [MUI's theme-aware propeties](https://mui.com/system/getting-started/the-sx-prop/#theme-aware-properties) - these are props available to any component without importing `theme`
- [index of color utilities exported from `@mui/material/styles`](https://github.com/mui/material-ui/blob/master/packages/mui-material/src/styles/index.d.ts#L52-L67) (see: [cusomizing colours](https://mui.com/material-ui/customization/palette/#custom-colors))

## 🧪 Testing

Playwright commands (these tests can be run the script command `yarn test:pw [OPTIONS]`):

```sh
# Run the end-to-end tests.
yarn playwright test

# Starts the interactive UI mode.
yarn playwright test --ui

# Runs the tests only on Desktop Chrome.
yarn playwright test --project=chromium

# Runs the tests in a specific file.
yarn playwright test example

# Runs the tests and opens a browser window
yarn playwright test --headed

# Runs the tests in debug mode.
yarn playwright test --debug

# Auto generate tests with Codegen.
yarn playwright codegen
```

If you want to use visual comparison to test pages render:

- when there are no base comparison images, a test run will fail once, but thereafter succeed (the base images are generated during the run)
- when there is a change to the UI, existing base comparison images will need to be updated with `yarn playwright test --update-snapshots`.

Visit https://playwright.dev/docs/intro for more information

## 👷 Building

For reduced production build size the project has been configured for [`standalone` output](https://nextjs.org/docs/app/api-reference/next-config-js/output) based on https://calvinf.com/blog/2023/11/10/node-js-20-yarn-4-and-next-js-on-docker/.

Note the `configure experimental.outputFileTracingExcludes` and `experimental.outputFileTracingIncludes` as needed.

### Running a test build by-passing eslint

```sh
NEXT_DISABLE_ESLINT=true yarn build
```

### Running a local build

[`dumb-init`](https://github.com/Yelp/dumb-init) needs to be installed to run the server.

```sh
cp .env.local .next/standalone/.env.local
cp -r public .next/standalone/public
cp -r .next/static .next/standalone/.next/static
dumb-init node .next/standalone/server.js
```

## 📦 Containerization

### Single project variant

```sh
docker build . --build-arg BUILD_VARIANT={BUILD_VARIANT} --tag {TAG} --no-cache
docker run --detach --rm --env-file .env.local --publish 3333:3000 --name {CONTATINER_NAME} {TAG}
```

The project will be available at `http://localhost:3333/{VARIAENT_BASE_PATH}`. As `3000` is the default port for Next.js apps so here we publish it on local port `3333` to avoid port conflics with other locally deployed apps (i.e. BN).

To shut down gracefully run:

```sh
docker stop {TAG}
```

### Multiple Docker services

```sh
export RESTART_POLICY=no # optional variable
docker compose build --no-cache
docker compose up --force-recreate -d
```

To disable the progress indicator and get more detailed output add the `--progress=plain` argument between the compose and build commands.

NGINX is added to the docker-compose setting so that the environment is more production-like with a webserver in front of the app.

The project with all build variants will be available at `http://localhost/{VARIAENT_BASE_PATH}`

To shut down:

```sh
docker compose down
```

To see the NGINX logs exit (Ctrl-C) and run:

```sh
docker logs nginx -f
```

## 🚢 Deployment

- [Deploument workflow model](https://www.figma.com/board/1H4N9FXyp0C0Vf7whd2aCK/Deployment-workflow?node-id=0-1&t=4E1ZQIDxTzHlmdMB-0)
- [server config](https://github.com/dharmamitra/server_conf/blob/master/devops/watchtower/README.md)
  - The DM api key is set in [the server docker-compose file](https://github.com/dharmamitra/server_conf/blob/master/devops/watchtower/docker-compose.yaml)
